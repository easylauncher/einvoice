<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- Bootstrap CSS -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

<!-- Professional Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link 
  href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" 
  rel="stylesheet"
/>

<title>Invoice Generator</title>
<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 20px;
    background: #f9f9f9;
  }
  h1, h2, h3 {
    color: #333;
  }
  .card {
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    border-radius: 6px;
  }
  .invoice-container {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    padding: 20px;
  }
  .invoice-header img {
    max-height: 50px;
  }
  .invoice-logo img {
    width: 200px;
    max-height: 200px;
    object-fit: contain;
  }
  .download-btn button,
  .share-btn button {
    background: #28a745;
    border: none;
    color: #fff;
  }
  .download-btn button:hover,
  .share-btn button:hover {
    background: #218838;
  }

  /* Reduce table padding even more */
  .invoice-details.table-sm th, .invoice-details.table-sm td,
  .invoice-summary.table-sm td, .invoice-summary.table-sm th {
    padding: 0.3rem !important;
    vertical-align: middle;
  }
</style>
</head>
<body>

<script>
// Set this to true for testing mode.
const TEST_MODE = true;
</script>

<h1 class="mb-4">Invoice Generator</h1>
<div class="container">
  <div class="row">
    <!-- Form Section -->
    <div class="col-12 col-lg-5 mb-4">
      <div class="card p-3">
        <h2 class="h4">Input Details</h2>
        <div class="form-group">
          <label for="startDate">Journey Start Date</label>
          <input type="date" class="form-control" id="startDate" />
        </div>
        <div class="form-group">
          <label for="startMeter">Journey Start Meter Reading (KM)</label>
          <input type="number" class="form-control" id="startMeter" placeholder="e.g. 1200" />
        </div>
        <div class="form-group">
          <label for="endDate">Journey End Date</label>
          <input type="date" class="form-control" id="endDate" />
        </div>
        <div class="form-group">
          <label for="endMeter">Journey End Meter Reading (KM)</label>
          <input type="number" class="form-control" id="endMeter" placeholder="e.g. 1480" />
        </div>
        <div class="form-group">
          <label for="toll">Toll Charges</label>
          <input type="number" step="0.01" class="form-control" id="toll" placeholder="e.g. 45.00" />
        </div>
        <div class="form-group">
          <label for="extras">Extra Expenses</label>
          <input type="number" step="0.01" class="form-control" id="extras" placeholder="e.g. 100.00" />
        </div>
        <div class="form-group">
          <label for="costPerKm">Cost per KM</label>
          <input type="number" step="0.01" class="form-control" id="costPerKm" placeholder="e.g. 5.00" />
        </div>
        <div class="mt-3">
          <button class="btn btn-primary" id="generateBtn">Generate Invoice</button>
        </div>
      </div>
    </div>

    <!-- Invoice Section -->
    <div class="col-12 col-lg-7 mb-4">
      <div class="card p-3">
        <h2 class="h4">Invoice Preview</h2>
        <div id="invoice" class="invoice-container d-none">
          <div class="invoice-header d-flex justify-content-between align-items-center mb-3">
            <div class="invoice-company">
              <h2 class="h5">ABC Travels</h2>
              <p class="mb-0">Preeti Nagar,<br/> Lucknow, India</p>
            </div>
            <div class="invoice-logo">
              <img src="https://raw.githubusercontent.com/easylauncher/assets/refs/heads/main/logo/EasyLauncherLogo02/LogoWithoutText/logo02.svg" alt="Company Logo" crossorigin="anonymous">
            </div>
          </div>

          <div class="invoice-details mb-3">
            <h3 class="h6">Invoice Details</h3>
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th>Journey Start Date</th>
                  <th>Journey End Date</th>
                  <th>Distance Covered (KM)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="displayStartDate"></td>
                  <td id="displayEndDate"></td>
                  <td id="displayDistance"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="invoice-summary mb-3">
            <h3 class="h6">Cost Summary</h3>
            <table class="table table-bordered table-sm w-auto ml-auto">
              <tbody>
                <tr>
                  <td><strong>Cost per KM:</strong></td>
                  <td id="displayCostPerKm"></td>
                </tr>
                <tr>
                  <td><strong>Toll:</strong></td>
                  <td id="displayToll"></td>
                </tr>
                <tr>
                  <td><strong>Extra Expenses:</strong></td>
                  <td id="displayExtras"></td>
                </tr>
                <tr>
                  <td><strong>Total Cost:</strong></td>
                  <td id="displayTotal"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="invoice-footer text-right">
            <p>Thank you for using our service!</p>
          </div>
        </div>
        <div class="download-btn text-center mt-3 d-none">
          <button id="downloadPdf" class="btn">Download as PDF</button>
        </div>
        <div class="share-btn text-center mt-3 d-none">
          <button id="shareInvoice" class="btn">Share Invoice</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include html2canvas and jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const generateBtn = document.getElementById('generateBtn');
  const invoiceEl = document.getElementById('invoice');
  const downloadPdfBtn = document.getElementById('downloadPdf');
  const shareBtn = document.getElementById('shareInvoice');

  // If TEST_MODE is true, populate form with sample values on load
  document.addEventListener('DOMContentLoaded', () => {
    if (TEST_MODE) {
      document.getElementById('startDate').value = '2024-12-01';
      document.getElementById('startMeter').value = '1200';
      document.getElementById('endDate').value = '2024-12-02';
      document.getElementById('endMeter').value = '1480';
      document.getElementById('toll').value = '150';
      document.getElementById('extras').value = '100';
      document.getElementById('costPerKm').value = '11';
    }
  });

  generateBtn.addEventListener('click', () => {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const startMeter = parseFloat(document.getElementById('startMeter').value);
    const endMeter = parseFloat(document.getElementById('endMeter').value);
    const toll = parseFloat(document.getElementById('toll').value) || 0;
    const extras = parseFloat(document.getElementById('extras').value) || 0;
    const costPerKm = parseFloat(document.getElementById('costPerKm').value);

    if(!startDate || !endDate || isNaN(startMeter) || isNaN(endMeter) || isNaN(costPerKm)) {
      alert('Please fill in all required fields properly.');
      return;
    }

    const distance = endMeter - startMeter;
    if(distance < 0) {
      alert('End meter reading should be greater than or equal to start meter reading.');
      return;
    }

    const travelCost = distance * costPerKm;
    const totalCost = travelCost + toll + extras;

    // Populate invoice fields
    document.getElementById('displayStartDate').textContent = startDate;
    document.getElementById('displayEndDate').textContent = endDate;
    document.getElementById('displayDistance').textContent = distance.toFixed(2) + ' KM';
    document.getElementById('displayCostPerKm').textContent = costPerKm.toFixed(2);
    document.getElementById('displayToll').textContent = toll.toFixed(2);
    document.getElementById('displayExtras').textContent = extras.toFixed(2);
    document.getElementById('displayTotal').textContent = totalCost.toFixed(2);

    invoiceEl.classList.remove('d-none');
    document.querySelector('.download-btn').classList.remove('d-none');
    document.querySelector('.share-btn').classList.remove('d-none');
  });

  downloadPdfBtn.addEventListener('click', async () => {
    const jsPDF = window.jspdf.jsPDF;
    const pdf = new jsPDF('p', 'pt', 'a4');

    // Short delay to ensure images/fonts are loaded
    await new Promise(res => setTimeout(res, 500));

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    const fileName = `invoice_${year}-${month}-${day}-${hours}-${minutes}-${seconds}.pdf`;

    await pdf.html(invoiceEl, {
      callback: function (pdf) {
        pdf.save(fileName);
      },
      autoPaging: true,
      x: 10,
      y: 10,
      html2canvas: {
        useCORS: true, // Allow cross-origin images
        scale: 2
      }
    });
  });

  shareBtn.addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');

    await new Promise(res => setTimeout(res, 500));

    await pdf.html(invoiceEl, {
      autoPaging: true,
      x: 10,
      y: 10,
      html2canvas: {
        useCORS: true,
        scale: 2
      }
    });

    const blob = pdf.output('blob');
    const file = new File([blob], "invoice.pdf", {type:'application/pdf'});

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          title: 'Invoice',
          text: 'Please find attached your invoice.',
          files: [file]
        });
      } catch (err) {
        alert('Sharing was cancelled or failed.');
      }
    } else {
      alert("Sharing is not supported on this device/browser. Please download the PDF and share manually.");
    }
  });
</script>

<!-- Optional Bootstrap JS (if needed) -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
